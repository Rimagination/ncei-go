<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCEI Go | GHCN Data Access</title>
    <meta name="description" content="Official NOAA NCEI Climate Data Access Tool">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === THEME VARIABLES === */
            --header-h: 90px;
            --radius-xl: 24px;
            --radius-md: 16px;
            
            /* Dark Mode (Default) - Deep Space */
            --bg-body: #020305;
            --bg-panel: rgba(11, 13, 18, 0.85); /* Glassy */
            --bg-card: #14171f;
            --text-main: #f0f4f8;
            --text-sub: #8a90a0;
            --border: 1px solid rgba(255,255,255,0.08);
            --shadow: 0 20px 60px rgba(0,0,0,0.6);
            
            /* Accents */
            --cyan: #00f3ff;           /* GHCN Daily/M/Y */
            --cyan-glow: rgba(0, 243, 255, 0.4);
            --purple: #bc13fe;         /* GHCN Hourly */
            --purple-glow: rgba(188, 19, 254, 0.4);
            --gold: #ffd700;           /* Selection / Warning */
            
            /* Dynamic Core Color */
            --accent: var(--cyan);
            --accent-glow: var(--cyan-glow);

            --backdrop: blur(12px);
            --date-scheme: dark;
        }

        [data-theme="light"] {
            /* Light Mode - Ceramic White */
            --bg-body: #f8fafc;
            --bg-panel: rgba(255, 255, 255, 0.85);
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: 1px solid rgba(0,0,0,0.06);
            --shadow: 0 20px 60px rgba(0,0,0,0.08);
            
            --cyan: #0284c7; 
            --cyan-glow: rgba(2, 132, 199, 0.3);
            --purple: #7c3aed;
            --purple-glow: rgba(124, 58, 237, 0.3);
            --gold: #d97706;
            
            --date-scheme: light;
        }

        /* RESET & BASE */
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.4s, color 0.4s; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(125,125,125,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* HEADER */
        header {
            height: var(--header-h); padding: 0 50px; background: var(--bg-panel); border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between; z-index: 100; position: relative;
            backdrop-filter: var(--backdrop);
        }
        
        .brand { cursor: pointer; display: flex; flex-direction: column; justify-content: center; }
        /* Reverted Size */
        .logo { font-family: 'Orbitron'; font-size: 42px; font-weight: 900; color: var(--text-main); letter-spacing: 2px; line-height: 1; text-shadow: 0 0 30px var(--accent-glow); transition: 0.3s; }
        .logo span { color: var(--accent); }
        .slogan { font-size: 11px; color: var(--text-sub); letter-spacing: 4px; text-transform: uppercase; font-weight: 700; margin-top: 8px; padding-left: 4px; }

        .theme-center-btn {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 56px; height: 56px; border-radius: 50%; border: var(--border); background: var(--bg-card);
            color: var(--text-main); font-size: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 102; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .theme-center-btn:hover { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 25px var(--gold); transform: translate(-50%, -50%) scale(1.15) rotate(180deg); }

        .menu-bar { display: flex; gap: 12px; background: rgba(125,125,125,0.05); padding: 6px; border-radius: 60px; border: var(--border); }
        .nav-btn {
            background: transparent; border: none; color: var(--text-sub); padding: 10px 24px;
            border-radius: 40px; cursor: pointer; display: flex; flex-direction: column; align-items: center; line-height: 1.1; transition: 0.3s;
        }
        /* Reverted Size */
        .nav-main-text { font-size: 13px; font-weight: 700; }
        .nav-sub-text { font-size: 9px; text-transform: uppercase; font-weight: 600; opacity: 0.6; margin-top: 3px; }
        .nav-btn:hover { color: var(--text-main); background: rgba(125,125,125,0.08); }
        .nav-btn.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 4px 15px var(--accent-glow); }

        /* LAYOUT */
        .layout { display: flex; height: calc(100vh - var(--header-h)); position: relative; }
        .map-box { flex: 1; position: relative; background: #000; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; background: var(--bg-body); }

        /* STATUS WIDGET (HIDDEN) */
        .db-status {
            display: none; /* Keep hidden as requested */
            position: absolute; top: 25px; left: 25px; z-index: 500;
            background: var(--bg-card); padding: 20px; border-radius: var(--radius-md); border: var(--border);
            box-shadow: var(--shadow); min-width: 280px; backdrop-filter: blur(10px);
        }
        .db-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 12px; }
        .db-label { color: var(--text-sub); font-weight: 600; }
        .db-indicator { display: flex; align-items: center; gap: 8px; font-family: 'JetBrains Mono'; font-size: 11px; color: var(--text-main); }
        .dot { width: 8px; height: 8px; border-radius: 50%; transition: 0.3s; }
        .dot.ok { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .dot.err { background: #ef4444; box-shadow: 0 0 5px #ef4444; }
        .upload-mini { 
            margin-top: 15px; width: 100%; padding: 10px; background: rgba(125,125,125,0.06); 
            border: 1px dashed var(--text-sub); color: var(--text-sub); cursor: pointer; 
            border-radius: 10px; font-size: 11px; text-align: center; transition: 0.3s;
            font-weight: 600;
        }
        .upload-mini:hover { border-color: var(--accent); color: var(--accent); background: rgba(125,125,125,0.1); }

        /* CONTROL PANEL */
        .ctrl-box { width: 460px; background: var(--bg-panel); border-left: var(--border); display: flex; flex-direction: column; z-index: 50; box-shadow: var(--shadow); backdrop-filter: var(--backdrop); }
        .ctrl-content { padding: 40px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 36px; }

        .section-h { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-left: 4px solid var(--accent); padding-left: 12px; transition: border-color 0.3s; }
        /* Reverted Size */
        .h-cn { font-size: 15px; font-weight: 800; color: var(--text-main); }
        .h-en { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-left: 8px; letter-spacing: 0.5px; }

        .status-card { 
            background: rgba(125,125,125,0.03); border: var(--border); border-radius: var(--radius-xl); 
            padding: 24px; text-align: center; transition: 0.4s; position: relative; overflow: hidden; 
        }
        .status-card.active { 
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(125,125,125,0.05) 100%); 
            border-color: var(--accent); box-shadow: 0 0 40px var(--accent-glow); 
        }
        /* Reverted Size */
        .st-val { font-size: 20px; font-weight: 800; color: var(--text-main); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .st-code { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--accent); background: rgba(125,125,125,0.1); padding: 5px 12px; border-radius: 6px; display: inline-block; }

        .batch-switch { display: flex; align-items: center; gap: 12px; background: rgba(125,125,125,0.05); padding: 8px 12px; border-radius: 10px; }
        /* Reverted Size */
        .switch-label { font-size: 12px; color: var(--text-main); font-weight: 600; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 42px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #666; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }

        .sel-list { max-height: 140px; overflow-y: auto; background: rgba(125,125,125,0.05); border-radius: 12px; padding: 5px; margin-top: 15px; display: none; border: var(--border); }
        .sel-item { padding: 10px 14px; border-bottom: 1px solid rgba(125,125,125,0.1); font-size: 13px; display: flex; justify-content: space-between; color: var(--text-main); align-items: center; }
        .sel-del { color: #ef4444; cursor: pointer; font-weight: 800; padding: 4px 8px; border-radius: 4px; }
        .sel-del:hover { background: rgba(239,68,68,0.1); }

        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .mode-btn { 
            background: rgba(125,125,125,0.04); border: 1px solid transparent; padding: 16px; border-radius: 16px; 
            cursor: pointer; text-align: center; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px; 
        }
        .mb-en { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-main); letter-spacing: 1px; }
        /* Reverted Size */
        .mb-cn { font-size: 13px; color: var(--text-sub); }
        .mode-btn:hover { background: rgba(125,125,125,0.08); }
        .mode-btn.active { background: var(--bg-card); border-color: var(--accent); box-shadow: 0 4px 20px var(--accent-glow); color: var(--accent); }

        /* Reverted Size */
        input[type="date"] { width: 100%; padding: 16px; background: rgba(125,125,125,0.05); border: 1px solid rgba(125,125,125,0.2); border-radius: 12px; color: var(--text-main); font-family: 'Inter'; box-sizing: border-box; color-scheme: var(--date-scheme); font-size: 14px; }
        input[type="date"]:focus { outline: none; border-color: var(--accent); background: var(--bg-card); box-shadow: 0 0 15px var(--accent-glow); }

        .search-wrap { position: relative; }
        /* Reverted Size */
        input[type="text"] { width: 100%; padding: 16px; background: rgba(125,125,125,0.05); border: 1px solid rgba(125,125,125,0.2); border-radius: 12px; color: var(--text-main); font-family: 'Inter'; box-sizing: border-box; font-size: 14px; }
        input[type="text"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); background: var(--bg-card); }
        .search-res { position: absolute; top: 115%; left: 0; right: 0; background: var(--bg-card); border: var(--border); border-radius: var(--radius-md); max-height: 300px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .search-item { padding: 14px 18px; border-bottom: 1px solid rgba(125,125,125,0.05); cursor: pointer; font-size: 13px; color: var(--text-main); transition: 0.2s; }
        .search-item b { color: var(--accent); }
        .search-item:hover { background: rgba(125,125,125,0.1); padding-left: 24px; }

        .btn-dl { 
            width: 100%; padding: 20px; border: none; border-radius: 60px; background: rgba(125,125,125,0.1); 
            color: var(--text-sub); font-weight: 800; font-size: 14px; cursor: not-allowed; margin-top: auto; 
            transition: 0.3s; letter-spacing: 1px; text-transform: uppercase; 
        }
        .btn-dl.ready { background: var(--accent); color: #000; cursor: pointer; box-shadow: 0 0 25px var(--accent-glow); }
        .btn-dl.ready:hover { transform: translateY(-2px) scale(1.02); filter: brightness(1.1); }

        /* DRAWER */
        .drawer-overlay { position: absolute; top: var(--header-h); left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 150; display: none; backdrop-filter: blur(4px); cursor: pointer; transition: opacity 0.3s; }
        .drawer-overlay.active { display: block; }
        .drawer { 
            position: absolute; top: var(--header-h); right: 0; bottom: 0; width: 680px; 
            background: var(--bg-card); border-left: var(--border); z-index: 200; 
            transform: translateX(100%); transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; flex-direction: column; box-shadow: var(--shadow); 
        }
        .drawer.open { transform: translateX(0); }
        
        .doc-nav { display: flex; background: var(--bg-panel); border-bottom: var(--border); padding: 0 30px; gap: 20px; }
        /* Reverted Size */
        .doc-tab { flex: 1; text-align: center; padding: 24px 0; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .doc-tab:hover { color: var(--text-main); }
        .doc-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .doc-content { padding: 60px 50px; overflow-y: auto; flex: 1; }
        .doc-section { display: none; animation: fadeIn 0.4s; }
        .doc-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Reverted Size */
        .doc-h1 { font-size: 28px; font-weight: 900; margin-bottom: 12px; color: var(--text-main); letter-spacing: -0.5px; }
        /* Reverted Size */
        .doc-sub { font-size: 15px; color: var(--text-sub); margin-bottom: 40px; border-left: 3px solid var(--accent); padding-left: 15px; line-height: 1.6; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; border: var(--border); border-radius: 12px; overflow: hidden; }
        /* Reverted Size */
        th { text-align: left; padding: 18px; background: rgba(125,125,125,0.04); color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; border-bottom: 1px solid rgba(125,125,125,0.1); }
        /* Reverted Size */
        td { padding: 16px; border-bottom: 1px solid rgba(125,125,125,0.05); color: var(--text-main); font-size: 13px; line-height: 1.6; }
        tr:last-child td { border-bottom: none; }
        .code-tag { font-family: 'JetBrains Mono'; color: var(--accent); background: rgba(125,125,125,0.1); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        
        .cite-block { background: rgba(125,125,125,0.03); border: var(--border); border-left: 4px solid var(--gold); padding: 25px; font-family: 'Georgia', serif; font-style: italic; color: var(--text-main); margin-bottom: 30px; line-height: 1.8; border-radius: 0 12px 12px 0; }
        
        /* Marker Cluster Customization */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: var(--accent-glow) !important; }
        .marker-cluster div { background-color: var(--accent) !important; color: #000 !important; font-weight: 800; border-radius: 50%; }
        
        /* Dreamy Glow Animation */
        .dream-pulse { position: relative; }
        .dream-pulse::after { 
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 10px; height: 10px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 10px var(--gold), 0 0 30px var(--accent);
            animation: pulseCore 2s infinite;
        }
        .dream-pulse::before {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            animation: pulseWave 2s infinite ease-out; z-index: -1;
        }
        @keyframes pulseCore { 0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 1; } 50% { transform: translate(-50%,-50%) scale(1.5); opacity: 0.8; } }
        @keyframes pulseWave { 0% { transform: translate(-50%,-50%) scale(0.2); opacity: 1; } 100% { transform: translate(-50%,-50%) scale(2.5); opacity: 0; } }

    </style>
</head>
<body>

    <header>
        <div class="brand" onclick="location.reload()">
            <div class="logo">NCEI <span>GO</span></div>
            <div class="slogan">NCEI å³åˆ»å‡ºå‘ Â· Official Climate Archive</div>
        </div>
        
        <div class="theme-center-btn" onclick="toggleTheme()" id="theme-btn" title="Light/Dark Mode">â˜€ï¸</div>

        <div class="menu-bar">
            <button class="nav-btn active" onclick="closeDrawer()">
                <span class="nav-main-text">åœ°ç†æ§åˆ¶å°</span><span class="nav-sub-text">Console</span>
            </button>
            <button class="nav-btn" onclick="toggleDrawer('doc', this)">
                <span class="nav-main-text">å˜é‡è¯´æ˜</span><span class="nav-sub-text">Variables</span>
            </button>
            <button class="nav-btn" onclick="toggleDrawer('cite', this)">
                <span class="nav-main-text">å¼•ç”¨æ–¹å¼</span><span class="nav-sub-text">Citation</span>
            </button>
            <button class="nav-btn" onclick="toggleDrawer('about', this)">
                <span class="nav-main-text">å…³äºæœ¬ç«™</span><span class="nav-sub-text">About</span>
            </button>
        </div>
    </header>

    <div class="layout">
        <div class="map-box">
            <div class="db-status">
                <div class="db-row">
                    <span class="db-label">GHCN-D/M/Y Index (ghcnd-stations.txt)</span>
                    <div class="db-indicator">
                        <span id="label-daily">Initializing...</span>
                        <div class="dot" id="dot-daily"></div>
                    </div>
                </div>
                <div class="db-row">
                    <span class="db-label">GHCN-Hourly Index (isd-history.csv)</span>
                    <div class="db-indicator">
                        <span id="label-hourly">Initializing...</span>
                        <div class="dot" id="dot-hourly"></div>
                    </div>
                </div>
                <div class="upload-mini" onclick="document.getElementById('file-input').click()">
                    ğŸ“‚ æ‰‹åŠ¨åŠ è½½ Index æ–‡ä»¶ (txt / csv)
                </div>
                <input type="file" id="file-input" hidden accept=".txt,.csv" onchange="handleFile(this)">
            </div>

            <div id="map"></div>
            <div class="drawer-overlay" onclick="closeDrawer()"></div>
        </div>

        <aside class="ctrl-box">
            <div class="ctrl-content">
                <div>
                    <div class="section-h">
                        <div><span class="h-cn">1. ç«™ç‚¹é€‰æ‹©</span><span class="h-en">Selection</span></div>
                        <div class="batch-switch">
                            <label class="switch-label" for="multi-check">æ‰¹é‡å¤šé€‰</label>
                            <label class="switch"><input type="checkbox" id="multi-check" class="switch-input"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="search-wrap">
                        <input type="text" id="search" placeholder="è¾“å…¥ ID æˆ–åŸå¸‚å (å¦‚ Beijing)..." oninput="handleSearch(this.value)">
                        <div class="search-res" id="results"></div>
                    </div>
                    
                    <div class="status-card" id="status-card" style="margin-top:20px;">
                        <div class="st-title" id="sel-status" style="font-size:12px; color:var(--text-sub); font-weight:700; text-transform:uppercase; margin-bottom:5px;">æœªé€‰æ‹©ç«™ç‚¹</div>
                        <div class="st-val" id="st-name">ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹</div>
                        <div class="st-code" id="st-id">æ”¯æŒ Shift+æ¡†é€‰åŒºåŸŸ</div>
                    </div>
                    <div class="sel-list" id="sel-list"></div>
                </div>

                <div>
                    <div class="section-h"><div><span class="h-cn">2. æ•°æ®ç±»å‹</span><span class="h-en">Dataset</span></div></div>
                    <div class="mode-grid">
                        <div class="mode-btn" onclick="setMode('hourly')" id="m-hourly"><span class="mb-en">Hourly</span><span class="mb-cn">GHCNh</span></div>
                        <div class="mode-btn active" onclick="setMode('daily')" id="m-daily"><span class="mb-en">Daily</span><span class="mb-cn">GHCNd</span></div>
                        <div class="mode-btn" onclick="setMode('monthly')" id="m-monthly"><span class="mb-en">Monthly</span><span class="mb-cn">GSOM</span></div>
                        <div class="mode-btn" onclick="setMode('yearly')" id="m-yearly"><span class="mb-en">Yearly</span><span class="mb-cn">GSOY</span></div>
                    </div>
                </div>

                <div>
                    <div class="section-h"><div><span class="h-cn">3. æ—¶é—´èŒƒå›´</span><span class="h-en">Temporal</span></div></div>
                    <div style="display:flex; gap:12px;">
                        <input type="date" id="start-date" value="2023-01-01">
                        <input type="date" id="end-date" value="2023-01-31">
                    </div>
                </div>

                <div style="margin-top:auto;">
                    <div style="font-size:11px; color:var(--text-sub); text-align:center; margin-bottom:12px;">
                        ğŸ”— é“¾æ¥ç›´æ¥è¯·æ±‚ NOAA NCEI å®˜æ–¹ API<br>å¤šç«™ç‚¹å°†è‡ªåŠ¨åˆå¹¶ä¸ºå•ä¸ª CSV
                    </div>
                    <button class="btn-dl" id="dl-btn" onclick="download()">ä¸‹è½½æ•°æ® (CSV)</button>
                </div>
            </div>
        </aside>
    </div>

    <div class="drawer" id="doc-drawer">
        <div class="doc-nav">
            <div class="doc-tab active" id="tab-hourly" onclick="showDocSection('doc-hourly', this)">Hourly</div>
            <div class="doc-tab" id="tab-daily" onclick="showDocSection('doc-daily', this)">Daily</div>
            <div class="doc-tab" id="tab-monthly" onclick="showDocSection('doc-monthly', this)">Monthly/Yearly</div>
        </div>
        
        <div class="doc-content">
            <div id="doc-hourly" class="doc-section active">
                <div class="doc-h1">GHCN-Hourly (GHCNh)</div>
                <div class="doc-sub">Global Historical Climatology Network - Hourly. <br>API Dataset: <code>global-hourly</code>.</div>
                
                <h4 style="color:var(--text-main); margin-bottom:5px;">æ ¸å¿ƒå˜é‡ (Variables)</h4>
                <table>
                    <tr><th>ä»£ç </th><th>è¯´æ˜</th><th>è§£æç¤ºä¾‹</th></tr>
                    <tr><td class="code-tag">TMP</td><td>æ°”æ¸© (Temperature)</td><td>+0250,1 (25.0Â°C)</td></tr>
                    <tr><td class="code-tag">DEW</td><td>éœ²ç‚¹æ¸©åº¦ (Dew Point)</td><td>+0100,1 (10.0Â°C)</td></tr>
                    <tr><td class="code-tag">WND</td><td>é£å†µ (Wind)</td><td>320,1,N,0050,1</td></tr>
                    <tr><td class="code-tag">SLP</td><td>æµ·å¹³é¢æ°”å‹ (Sea Level Pressure)</td><td>10132,1 (1013.2hPa)</td></tr>
                    <tr><td class="code-tag">VIS</td><td>èƒ½è§åº¦ (Visibility)</td><td>008000,1 (8000m)</td></tr>
                    <tr><td class="code-tag">AA1</td><td>é™æ°´ (Precipitation)</td><td>01,0050 (1h/5.0mm)</td></tr>
                    <tr><td class="code-tag">GA1</td><td>äº‘å±‚è¦†ç›– (Sky Cover)</td><td>08,1,+00600 (8åˆ†, 600m)</td></tr>
                </table>
                <p style="font-size:12px; color:var(--text-sub); margin-top:10px;">*æ³¨ï¼šHourly æ•°æ®ä¸ºå®šé•¿å­—ç¬¦ä¸²æ ¼å¼ï¼Œéœ€æ ¹æ®æ‰‹å†Œè§£æé€—å·åˆ†éš”çš„å­—æ®µã€‚</p>
            </div>

            <div id="doc-daily" class="doc-section">
                <div class="doc-h1">GHCN-Daily (GHCNd)</div>
                <div class="doc-sub">GHCN Daily Summaries.<br>API Dataset: <code>daily-summaries</code>. å•ä½ï¼šå…¬åˆ¶ (Metric)ã€‚</div>
                <table>
                    <tr><th>ä»£ç </th><th>å®Œæ•´åç§°</th><th>å•ä½</th></tr>
                    <tr><td class="code-tag">TMAX</td><td>æ—¥æœ€é«˜æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">TMIN</td><td>æ—¥æœ€ä½æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">PRCP</td><td>æ—¥é™æ°´é‡</td><td>mm</td></tr>
                    <tr><td class="code-tag">SNOW</td><td>é™é›ªé‡</td><td>mm</td></tr>
                    <tr><td class="code-tag">SNWD</td><td>ç§¯é›ªæ·±åº¦</td><td>mm</td></tr>
                    <tr><td class="code-tag">AWND</td><td>å¹³å‡é£é€Ÿ</td><td>m/s</td></tr>
                    <tr><td class="code-tag">WDF2</td><td>2åˆ†é’Ÿæœ€å¿«é£å‘</td><td>deg</td></tr>
                    <tr><td class="code-tag">TOBS</td><td>è§‚æµ‹æ—¶æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">EVAP</td><td>è’¸å‘é‡</td><td>mm</td></tr>
                </table>
            </div>

            <div id="doc-monthly" class="doc-section">
                <div class="doc-h1">GSOM / GSOY</div>
                <div class="doc-sub">GHCN Global Summary of Month / Year.</div>
                <table>
                    <tr><th>ä»£ç </th><th>å«ä¹‰</th></tr>
                    <tr><td class="code-tag">EMXP</td><td>æ—¶æ®µå†…æç«¯æœ€å¤§å•æ—¥é™æ°´</td></tr>
                    <tr><td class="code-tag">HTDD</td><td>é‡‡æš–åº¦æ—¥æ•° (Heating Degree Days)</td></tr>
                    <tr><td class="code-tag">CLDD</td><td>åˆ¶å†·åº¦æ—¥æ•° (Cooling Degree Days)</td></tr>
                    <tr><td class="code-tag">DT90</td><td>æ°”æ¸©â‰¥90Â°F (32.2Â°C) å¤©æ•°</td></tr>
                    <tr><td class="code-tag">DX32</td><td>æ°”æ¸©â‰¤32Â°F (0Â°C) å¤©æ•°</td></tr>
                </table>
            </div>

            <div id="view-cite" class="doc-section">
                <div class="doc-h1">å¼•ç”¨æ–¹å¼ (Citation)</div>
                <div class="doc-sub">ä½¿ç”¨æ•°æ®è¯·éµå¾ª NOAA NCEI å®˜æ–¹å¼•ç”¨è§„èŒƒã€‚</div>
                
                <h4 style="color:var(--text-main); margin-bottom:10px;">GHCN-Daily (Menne et al. 2012)</h4>
                <div class="cite-block">
                    Menne, M.J., I. Durre, R.S. Vose, B.E. Gleason, and T.G. Houston, 2012: An overview of the Global Historical Climatology Network-Daily Database. Journal of Atmospheric and Oceanic Technology, 29, 897-910, doi:10.1175/JTECH-D-11-00103.1.
                </div>
                
                <h4 style="color:var(--text-main); margin-bottom:10px;">GHCN-Hourly (Menne et al. 2023)</h4>
                <div class="cite-block">
                    Menne, Matthew J., et al. 2023. Global Historical Climatology Network-Hourly (GHCNh). NOAA National Centers for Environmental Information.
                </div>
            </div>

            <div id="view-about" class="doc-section">
                <div class="doc-h1">å…³äºæœ¬ç«™ (About)</div>
                <div style="padding:40px; background:rgba(125,125,125,0.03); border-radius:24px; border:var(--border);">
                    <div style="font-family:'Orbitron'; font-size:32px; font-weight:900;">NCEI <span>GO</span></div>
                    
                    <div style="font-size:13px; color:var(--text-main); margin-top:25px; line-height:1.8;">
                        <p><strong>Global Historical Climatology Network (GHCN):</strong><br>
                        æœ¬ç«™ç›´è¿ NOAA å®˜æ–¹ GHCN æ•°æ®åº“ï¼Œæ”¯æŒä»¥ä¸‹å…¨å°ºåº¦æ°”è±¡æ•°æ®å½’æ¡£çš„ä¸€é”®ä¸‹è½½ï¼š</p>
                        <ul style="margin:10px 0 20px 0; padding-left:20px; color:var(--text-sub);">
                            <li><strong>Hourly:</strong> GHCNh (åŒ…å« Synoptic/Airways æ•°æ®)</li>
                            <li><strong>Daily:</strong> GHCNd (æ—¥åº¦æ‘˜è¦)</li>
                            <li><strong>Monthly:</strong> GHCNm (GSOM æœˆåº¦æ‘˜è¦)</li>
                            <li><strong>Yearly:</strong> GHCNy (GSOY å¹´åº¦æ‘˜è¦)</li>
                        </ul>

                        <p><strong>åŒæ ¸ç´¢å¼•å¼•æ“ (Dual-Core Indexing):</strong><br>
                        é‰´äº GHCN-Hourly ä½¿ç”¨ç‹¬ç«‹äºå…¶ä»–å°ºåº¦çš„ç«™ç‚¹ç´¢å¼•ä½“ç³» (USAF ID)ï¼Œæœ¬ç³»ç»Ÿé‡‡ç”¨åŒæ ¸æ¶æ„è‡ªåŠ¨åˆ‡æ¢åº•å±‚ç´¢å¼•æ–‡ä»¶ (<code>isd-history</code> vs <code>ghcnd-stations</code>)ï¼Œå½»åº•è§£å†³äº†ä¸åŒæ—¶é—´å°ºåº¦ä¸‹å›  ID ä¸åŒ¹é…å¯¼è‡´çš„æ•°æ®è¯·æ±‚å¤±è´¥é—®é¢˜ã€‚</p>
                        
                        <div style="margin-top:30px; border-top:1px solid rgba(125,125,125,0.1); padding-top:20px; color:var(--text-sub);">
                            <p style="margin-bottom:15px;"><strong>å…è´£å£°æ˜ï¼š</strong><br>
                            1. æœ¬é¡¹ç›®ä»…ä¾›å­¦æœ¯ç ”ç©¶ä¸æ•™è‚²ä½¿ç”¨ (Educational Purpose Only)ã€‚<br>
                            2. æ‰€æœ‰æ•°æ®é“¾æ¥ç›´è¿ NOAA å®˜æ–¹æœåŠ¡å™¨ï¼Œæœ¬ç«™ä¸å­˜å‚¨ä»»ä½•æ°”è±¡æ•°æ®ã€‚<br>
                            3. å¼€å‘è€…ä¸å¯¹ NOAA æ•°æ®çš„å‡†ç¡®æ€§åŠæœåŠ¡çš„å¯ç”¨æ€§æ‰¿æ‹…è´£ä»»ã€‚</p>

                            <div>Developer: <strong>Liang Ren</strong></div>
                            <div style="font-family:'JetBrains Mono'; font-size:12px; margin-top:5px;">rl23@mails.tsinghua.edu.cn</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // === CORE: FALLBACK DATA (Top 50 Cities) ===
        // å½“æ— æ³•åŠ è½½å®˜æ–¹å¤§æ–‡ä»¶æ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ­¤æ•°æ®ä»¥é˜²åœ°å›¾ç•™ç™½
        const CORE_CITIES_DAILY = [
            {id:"CHM00054511",name:"BEIJING",lat:39.933,lon:116.283},{id:"CHM00058362",name:"SHANGHAI",lat:31.400,lon:121.467},
            {id:"JA000047662",name:"TOKYO",lat:35.683,lon:139.767},{id:"USW00094728",name:"NEW YORK CNTRL PK",lat:40.779,lon:-73.969},
            {id:"UK000056225",name:"OXFORD",lat:51.767,lon:-1.267},{id:"FR000007150",name:"PARIS/LE BOURGET",lat:48.967,lon:2.433},
            {id:"GM000003380",name:"BERLIN-DAHLEM",lat:52.450,lon:13.300},{id:"RSM00027612",name:"MOSCOW",lat:55.833,lon:37.617},
            {id:"ASN00066062",name:"SYDNEY OBS HILL",lat:-33.861,lon:151.210},{id:"CA006105976",name:"OTTAWA CDA",lat:45.383,lon:-75.717},
            {id:"IN000042182",name:"NEW DELHI/SAFDARJUN",lat:28.583,lon:77.200},{id:"SF000068263",name:"PRETORIA",lat:-25.733,lon:28.183},
            {id:"BR002660040",name:"BRASILIA",lat:-15.783,lon:-47.933},{id:"AR000875850",name:"BUENOS AIRES OBS",lat:-34.583,lon:-58.483},
            {id:"EG000062366",name:"CAIRO",lat:30.133,lon:31.400},{id:"TH000048455",name:"BANGKOK METROPOLIS",lat:13.733,lon:100.567},
            {id:"SN000048698",name:"SINGAPORE/CHANGI",lat:1.367,lon:103.983},{id:"KS000047108",name:"SEOUL",lat:37.567,lon:126.967},
            {id:"IT000016242",name:"ROMA/FIUMICINO",lat:41.800,lon:12.233},{id:"SP000003129",name:"MADRID/BARAJAS",lat:40.467,lon:-3.550}
        ];

        const CORE_CITIES_HOURLY = [
            {id:"54511099999",name:"BEIJING - CAPITAL",lat:40.08,lon:116.58},{id:"47662099999",name:"TOKYO INTL",lat:35.55,lon:139.78},
            {id:"72503014732",name:"NEW YORK LA GUARDIA",lat:40.77,lon:-73.87},{id:"03772099999",name:"HEATHROW",lat:51.48,lon:-0.45},
            {id:"07150099999",name:"PARIS - LE BOURGET",lat:48.97,lon:2.42},{id:"10382099999",name:"BERLIN - TEGEL",lat:52.57,lon:13.32},
            {id:"94767099999",name:"SYDNEY ARPT",lat:-33.95,lon:151.18},{id:"71628099999",name:"TORONTO CITY",lat:43.63,lon:-79.40},
            {id:"42181099999",name:"NEW DELHI PALAM",lat:28.57,lon:77.12},{id:"98135099999",name:"MANILA NINOY AQUINO",lat:14.50,lon:121.00},
            {id:"48453099999",name:"BANGKOK DON MUANG",lat:13.90,lon:100.60},{id:"48698099999",name:"SINGAPORE CHANGI",lat:1.35,lon:103.98},
            {id:"16242099999",name:"ROME FIUMICINO",lat:41.80,lon:12.25},{id:"08221099999",name:"MADRID BARAJAS",lat:40.47,lon:-3.56}
        ];

        // === APP STATE ===
        let db = { daily: [], hourly: [] };
        let map, clusterLayer, glowLayer;
        let selectedStations = new Set();
        let currentMode = 'daily'; // daily, hourly, monthly, yearly

        function init() {
            // Map Setup
            map = L.map('map', { zoomControl: false, boxZoom: true }).setView([30, 0], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            updateTiles(); // Initial theme check

            // Layers
            clusterLayer = L.markerClusterGroup({ 
                chunkedLoading: true, 
                showCoverageOnHover: false, 
                maxClusterRadius: 45,
                spiderfyOnMaxZoom: true
            });
            map.addLayer(clusterLayer);
            
            glowLayer = L.layerGroup().addTo(map);

            // Interaction Hooks
            map.on('click', (e) => {
                // Click on blank map clears selection
                if(e.originalEvent.target.classList.contains('leaflet-container')) {
                    selectedStations.clear(); updateUI();
                    if(document.querySelector('.drawer').classList.contains('open')) closeDrawer();
                }
            });

            // Leaflet BoxZoom Handler for Selection
            map.boxZoom.addHooks();
            map.on('boxzoomend', (e) => handleBoxSelect(e.boxZoomBounds));

            // Start Auto-Loader
            loadDualCores();
        }

        // === CORE: AUTO-LOADER ===
        async function loadDualCores() {
            // 1. Daily Core
            try {
                updateStatus('daily', 'loading');
                const res = await fetch('ghcnd-stations.txt');
                if(!res.ok) throw new Error("File not found");
                const text = await res.text();
                parseData(text, 'daily');
                updateStatus('daily', 'ok', db.daily.length);
            } catch(e) {
                console.warn("GHCN-D local file failed, using fallback.");
                db.daily = CORE_CITIES_DAILY; // Fallback
                updateStatus('daily', 'err', 0);
            }

            // 2. Hourly Core
            try {
                updateStatus('hourly', 'loading');
                const res = await fetch('isd-history.csv');
                if(!res.ok) throw new Error("File not found");
                const text = await res.text();
                parseData(text, 'hourly');
                updateStatus('hourly', 'ok', db.hourly.length);
            } catch(e) {
                console.warn("GHCN-H local file failed, using fallback.");
                db.hourly = CORE_CITIES_HOURLY; // Fallback
                updateStatus('hourly', 'err', 0);
            }

            // Initial Render
            renderMap();
        }

        function updateStatus(type, status, count) {
            const el = document.getElementById('label-'+type);
            const dot = document.getElementById('dot-'+type);
            if(status === 'ok') {
                el.innerText = `Ready (${count.toLocaleString()})`;
                dot.className = 'dot ok';
            } else if (status === 'loading') {
                el.innerText = `Checking...`;
                dot.className = 'dot';
            } else {
                el.innerText = `Index Missing (Using Demo)`;
                dot.className = 'dot err';
            }
        }

        // === DATA PARSER ===
        function parseData(text, type) {
            const lines = text.split('\n');
            const arr = [];
            
            if(type === 'daily') {
                // Fixed Width: ID(0-11), LAT(12-20), LON(21-30), NAME(41-71)
                for(let line of lines) {
                    if(line.length > 20) {
                        arr.push({
                            id: line.substring(0,11).trim(),
                            lat: parseFloat(line.substring(12,20)),
                            lon: parseFloat(line.substring(21,30)),
                            name: line.substring(41,71).trim()
                        });
                    }
                }
                db.daily = arr;
            } else {
                // CSV: USAF(0), WBAN(1), NAME(2), ... LAT(6), LON(7)
                // Skip header
                for(let i=1; i<lines.length; i++) {
                    const p = lines[i].split(','); 
                    if(p.length > 7) {
                        const lat = parseFloat(p[6].replace(/"/g,''));
                        const lon = parseFloat(p[7].replace(/"/g,''));
                        if(!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                            arr.push({
                                id: p[0].replace(/"/g,'') + p[1].replace(/"/g,''), // USAF+WBAN
                                name: p[2].replace(/"/g,''),
                                lat: lat, lon: lon
                            });
                        }
                    }
                }
                db.hourly = arr;
            }
        }

        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const isCSV = file.name.toLowerCase().includes('csv');
                if(isCSV) {
                    parseData(text, 'hourly');
                    updateStatus('hourly', 'ok', db.hourly.length);
                    alert("âœ… GHCN-Hourly Index Updated!");
                    setMode('hourly');
                } else {
                    parseData(text, 'daily');
                    updateStatus('daily', 'ok', db.daily.length);
                    alert("âœ… GHCN-Daily/M/Y Index Updated!");
                    setMode('daily');
                }
            };
            reader.readAsText(file);
        }

        // === MODE & RENDER ===
        function setMode(mode) {
            currentMode = mode;
            
            // 1. UI Updates
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('m-'+mode).classList.add('active');
            
            // 2. Theme Colors
            const root = document.documentElement;
            if(mode === 'hourly') {
                root.style.setProperty('--accent', 'var(--purple)');
                root.style.setProperty('--accent-glow', 'var(--purple-glow)');
            } else {
                root.style.setProperty('--accent', 'var(--cyan)');
                root.style.setProperty('--accent-glow', 'var(--cyan-glow)');
            }

            // 3. Clear Map
            selectedStations.clear();
            updateUI();
            renderMap();
        }

        function renderMap() {
            clusterLayer.clearLayers();
            const markers = [];
            // Select DB based on Mode (Daily/Monthly/Yearly share GHCN-D, Hourly uses GHCN-H)
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            
            // Limit render to avoid freeze if too large (standard Leaflet limits)
            const limit = stations.length; 
            
            for(let i=0; i<limit; i++) {
                const s = stations[i];
                // Create simple marker
                const m = L.marker([s.lat, s.lon]);
                // Click Event
                m.on('click', (e) => { 
                    L.DomEvent.stopPropagation(e); // Stop bubbling
                    handlePointClick(s); 
                });
                markers.push(m);
            }
            clusterLayer.addLayers(markers);
        }

        // === SELECTION LOGIC ===
        function handlePointClick(s) {
            const isMulti = document.getElementById('multi-check').checked;
            
            if(isMulti) {
                // Add/Remove logic
                let found = false;
                for(let item of selectedStations) {
                    if(item.id === s.id) { selectedStations.delete(item); found = true; break; }
                }
                if(!found) selectedStations.add(s);
            } else {
                // Replace logic
                selectedStations.clear();
                selectedStations.add(s);
            }
            updateUI();
        }

        function handleBoxSelect(bounds) {
            // Shift + Drag Logic
            document.getElementById('multi-check').checked = true; // Auto-enable multi
            
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            let count = 0;
            
            for(let s of stations) {
                // Basic bounds check
                if(s.lat >= bounds.getSouth() && s.lat <= bounds.getNorth() &&
                   s.lon >= bounds.getWest() && s.lon <= bounds.getEast()) {
                    selectedStations.add(s);
                    count++;
                }
                // Cap selection for performance safety
                if(count > 200) break; 
            }
            updateUI();
        }

        function updateUI() {
            // 1. Render Glow Effects
            glowLayer.clearLayers();
            selectedStations.forEach(s => {
                const glow = L.marker([s.lat, s.lon], { 
                    icon: L.divIcon({ 
                        className: 'dream-pulse', 
                        iconSize: [20,20], 
                        iconAnchor: [10,10] 
                    }),
                    interactive: false 
                });
                glowLayer.addLayer(glow);
            });

            // 2. Update Card
            const card = document.getElementById('status-card');
            const btn = document.getElementById('dl-btn');
            const list = document.getElementById('sel-list');
            const arr = Array.from(selectedStations);

            if(arr.length === 0) {
                card.classList.remove('active');
                document.getElementById('sel-status').textContent = "æœªé€‰æ‹©ç«™ç‚¹";
                document.getElementById('st-name').textContent = "ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹";
                document.getElementById('st-id').textContent = "æ”¯æŒ Shift+æ¡†é€‰åŒºåŸŸ";
                btn.className = 'btn-dl'; 
                btn.innerText = 'Generate Link'; 
                btn.disabled = true;
                list.style.display = 'none';
            } else {
                card.classList.add('active');
                document.getElementById('sel-status').textContent = "å·²é€‰ä¸­";
                
                if(arr.length === 1) {
                    // Single Mode
                    const s = arr[0];
                    document.getElementById('st-name').textContent = s.name;
                    document.getElementById('st-id').textContent = "ID: " + s.id;
                    list.style.display = 'none';
                } else {
                    // Batch Mode
                    document.getElementById('st-name').textContent = `å·²é€‰ ${arr.length} ä¸ªç«™ç‚¹`;
                    document.getElementById('st-id').textContent = "ç«™ç‚¹åˆ—è¡¨å¦‚ä¸‹ â†“";
                    list.style.display = 'block';
                    list.innerHTML = arr.map(s => `
                        <div class="sel-item">
                            <span>${s.name.substring(0,25)}</span>
                            <span class="sel-del" onclick="removeOne('${s.id}')">Ã—</span>
                        </div>
                    `).join('');
                }
                btn.className = 'btn-dl ready'; 
                btn.innerText = `ä¸‹è½½æ•°æ® (CSV)`; 
                btn.disabled = false;
            }
        }

        window.removeOne = function(id) {
            for(let s of selectedStations) { 
                if(s.id === id) { selectedStations.delete(s); break; } 
            }
            updateUI();
        }

        // === SEARCH ===
        function handleSearch(val) {
            const res = document.getElementById('results');
            res.innerHTML = '';
            if(val.length < 2) { res.style.display = 'none'; return; }
            
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            const upperVal = val.toUpperCase();
            
            // Filter top 10
            const matches = stations.filter(s => 
                s.name.toUpperCase().includes(upperVal) || s.id.includes(upperVal)
            ).slice(0, 15);
            
            matches.forEach(s => {
                const d = document.createElement('div');
                d.className = 'search-item';
                d.innerHTML = `<b>${s.name}</b> <span style="font-size:11px; opacity:0.7; margin-left:5px;">${s.id}</span>`;
                d.onclick = () => {
                    map.setView([s.lat, s.lon], 10);
                    handlePointClick(s); // Use standard selection logic
                    res.style.display = 'none';
                    document.getElementById('search').value = s.name;
                };
                res.appendChild(d);
            });
            res.style.display = matches.length ? 'block' : 'none';
        }

        // === DOWNLOAD GENERATOR ===
        function download() {
            if(selectedStations.size === 0) return;
            const baseUrl = "https://www.ncei.noaa.gov/access/services/data/v1";
            
            // 1. Determine Dataset
            let dataset = 'daily-summaries';
            let dataTypes = ''; // For GHCN-D optimization
            
            if(currentMode === 'hourly') {
                dataset = 'global-hourly';
            } else if(currentMode === 'daily') {
                dataset = 'daily-summaries';
                dataTypes = 'TMAX,TMIN,PRCP,TAVG,SNOW,SNWD,AWND'; // Core vars
            } else if(currentMode === 'monthly') {
                dataset = 'global-summary-of-the-month';
            } else if(currentMode === 'yearly') {
                dataset = 'global-summary-of-the-year';
            }

            // 2. Build IDs
            const ids = Array.from(selectedStations).map(s => s.id).join(',');

            // 3. Build Params
            const params = new URLSearchParams({
                dataset: dataset,
                stations: ids,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                format: 'csv',
                units: 'metric', // Official Metric
                includeStationName: 'true'
            });

            if(dataTypes) params.append('dataTypes', dataTypes);

            window.open(`${baseUrl}?${params.toString()}`, '_blank');
        }

        // === UI UTILS ===
        function toggleDrawer(view, btn) {
            const d = document.getElementById('doc-drawer');
            const o = document.querySelector('.drawer-overlay');
            
            // Reset Nav Buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if(btn) {
                // Toggle Logic
                if(d.classList.contains('open') && btn.classList.contains('last-clicked')) {
                    closeDrawer(); return;
                }
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('last-clicked'));
                btn.classList.add('active'); 
                btn.classList.add('last-clicked');
                
                d.classList.add('open'); 
                o.classList.add('active');
                
                // Content Switching
                document.querySelectorAll('.doc-section').forEach(s => s.classList.remove('active'));
                document.querySelector('.doc-nav').style.display = 'none'; // Default Hide

                if(view === 'doc') {
                    document.querySelector('.doc-nav').style.display = 'flex';
                    showDocSection('doc-hourly', document.getElementById('tab-hourly'));
                } else if(view === 'cite') {
                    document.getElementById('view-cite').classList.add('active');
                } else if(view === 'about') {
                    document.getElementById('view-about').classList.add('active');
                }
            }
        }

        function showDocSection(id, tab) {
            document.querySelectorAll('.doc-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        }

        function closeDrawer() {
            document.getElementById('doc-drawer').classList.remove('open');
            document.querySelector('.drawer-overlay').classList.remove('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[0].classList.add('active'); // Back to console
        }

        function toggleTheme() {
            const root = document.documentElement;
            const isDark = root.getAttribute('data-theme') === 'dark';
            root.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('theme-btn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            updateTiles();
        }

        function updateTiles() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.TileLayer) map.removeLayer(l); });
            
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            // Use CartoDB Positron/DarkMatter for clean aesthetic
            const url = isDark 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            
            L.tileLayer(url, { 
                subdomains: 'abcd', 
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>' 
            }).addTo(map);
        }

        // Start
        init();

    </script>
</body>
</html>
