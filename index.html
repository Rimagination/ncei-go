<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCEI Go | GHCN Data Access</title>
    <meta name="description" content="Official NOAA NCEI Climate Data Access Tool">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === THEME VARIABLES === */
            --header-h: 72px;
            --radius-xl: 20px;
            --radius-md: 12px;
            
            /* Dark Mode (Default) */
            --bg-body: #020305;
            --bg-panel: rgba(11, 13, 18, 0.9);
            --bg-card: #14171f;
            --text-main: #f0f4f8;
            --text-sub: #8a90a0;
            --border: 1px solid rgba(255,255,255,0.08);
            --shadow: 0 10px 40px rgba(0,0,0,0.6);
            
            /* Accents */
            --cyan: #00f3ff;
            --cyan-glow: rgba(0, 243, 255, 0.4);
            --purple: #bc13fe;
            --purple-glow: rgba(188, 19, 254, 0.4);
            --gold: #ffd700;
            
            --accent: var(--cyan);
            --accent-glow: var(--cyan-glow);
            --backdrop: blur(12px);
            --date-scheme: dark;
        }

        [data-theme="light"] {
            --bg-body: #f8fafc;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: 1px solid rgba(0,0,0,0.06);
            --shadow: 0 10px 40px rgba(0,0,0,0.08);
            --cyan: #0284c7; --cyan-glow: rgba(2, 132, 199, 0.3);
            --purple: #7c3aed; --purple-glow: rgba(124, 58, 237, 0.3);
            --gold: #d97706;
            --date-scheme: light;
        }

        /* RESET */
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.4s; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(125,125,125,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* HEADER */
        header {
            height: var(--header-h); padding: 0 30px; background: var(--bg-panel); border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between; z-index: 100; position: relative;
            backdrop-filter: var(--backdrop);
        }
        .brand { cursor: pointer; }
        .logo { font-family: 'Orbitron'; font-size: 32px; font-weight: 900; color: var(--text-main); letter-spacing: 1px; line-height: 1; text-shadow: 0 0 20px var(--accent-glow); }
        .logo span { color: var(--accent); }
        .slogan { font-size: 10px; color: var(--text-sub); letter-spacing: 3px; text-transform: uppercase; font-weight: 700; margin-top: 4px; padding-left: 2px; }

        .theme-center-btn {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 48px; height: 48px; border-radius: 50%; border: var(--border); background: var(--bg-card);
            color: var(--text-main); font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.4s; z-index: 102; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .theme-center-btn:hover { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 20px var(--gold); transform: translate(-50%, -50%) scale(1.1); }

        .menu-bar { display: flex; gap: 8px; background: rgba(125,125,125,0.05); padding: 4px; border-radius: 40px; border: var(--border); }
        .nav-btn {
            background: transparent; border: none; color: var(--text-sub); padding: 8px 20px;
            border-radius: 30px; cursor: pointer; display: flex; flex-direction: column; align-items: center; line-height: 1.1; transition: 0.3s;
        }
        .nav-main-text { font-size: 13px; font-weight: 700; }
        .nav-sub-text { font-size: 9px; text-transform: uppercase; font-weight: 600; opacity: 0.6; margin-top: 2px; }
        .nav-btn:hover { color: var(--text-main); background: rgba(125,125,125,0.08); }
        .nav-btn.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 2px 10px var(--accent-glow); }

        /* LAYOUT */
        .layout { display: flex; height: calc(100vh - var(--header-h)); position: relative; }
        .map-box { flex: 1; position: relative; background: #000; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; background: var(--bg-body); }
        .db-status { display: none; }

        /* CONTROL PANEL */
        .ctrl-box { width: 440px; background: var(--bg-panel); border-left: var(--border); display: flex; flex-direction: column; z-index: 50; box-shadow: var(--shadow); backdrop-filter: var(--backdrop); }
        .ctrl-content { padding: 24px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 18px; }

        .section-h { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 10px; transition: border-color 0.3s; }
        .h-cn { font-size: 16px; font-weight: 800; color: var(--text-main); } 
        .h-en { font-size: 10px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-left: 8px; }

        .status-card { background: rgba(125,125,125,0.03); border: var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center; transition: 0.4s; position: relative; overflow: hidden; }
        .status-card.active { border-color: var(--accent); box-shadow: 0 0 25px var(--accent-glow); background: linear-gradient(145deg, var(--bg-card), rgba(125,125,125,0.05)); }
        .st-val { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .st-code { font-family: 'JetBrains Mono'; font-size: 11px; color: var(--accent); background: rgba(125,125,125,0.1); padding: 4px 10px; border-radius: 4px; display: inline-block; }

        .batch-switch { display: flex; align-items: center; gap: 8px; background: rgba(125,125,125,0.05); padding: 6px 10px; border-radius: 8px; }
        .switch-label { font-size: 11px; color: var(--text-main); font-weight: 600; cursor: pointer; white-space: nowrap; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #666; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        .sel-list { max-height: 120px; overflow-y: auto; background: rgba(125,125,125,0.05); border-radius: 8px; padding: 4px; margin-top: 10px; display: none; border: var(--border); }
        .sel-item { padding: 8px 12px; border-bottom: 1px solid rgba(125,125,125,0.1); font-size: 12px; display: flex; justify-content: space-between; color: var(--text-main); align-items: center; }
        .sel-del { color: #ef4444; cursor: pointer; font-weight: 800; padding: 2px 6px; }

        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mode-btn { background: rgba(125,125,125,0.04); border: 1px solid transparent; padding: 12px; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .mb-en { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--text-main); }
        .mb-cn { font-size: 12px; color: var(--text-sub); }
        .mode-btn:hover { background: rgba(125,125,125,0.08); }
        .mode-btn.active { background: var(--bg-card); border-color: var(--accent); box-shadow: 0 2px 15px var(--accent-glow); color: var(--accent); }

        input[type="date"], input[type="text"] { width: 100%; padding: 12px; background: rgba(125,125,125,0.05); border: 1px solid rgba(125,125,125,0.2); border-radius: 10px; color: var(--text-main); font-family: 'Inter'; box-sizing: border-box; font-size: 13px; }
        input[type="date"]:focus, input[type="text"]:focus { outline: none; border-color: var(--accent); background: var(--bg-card); box-shadow: 0 0 10px var(--accent-glow); }
        input[type="date"] { color-scheme: var(--date-scheme); }

        .search-wrap { position: relative; }
        .search-res { position: absolute; top: 110%; left: 0; right: 0; background: var(--bg-card); border: var(--border); border-radius: var(--radius-md); max-height: 250px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .search-item { padding: 10px 14px; border-bottom: 1px solid rgba(125,125,125,0.05); cursor: pointer; font-size: 12px; color: var(--text-main); }
        .search-item:hover { background: rgba(125,125,125,0.1); padding-left: 18px; }

        .btn-dl { width: 100%; padding: 16px; border: none; border-radius: 40px; background: rgba(125,125,125,0.1); color: var(--text-sub); font-weight: 800; font-size: 13px; cursor: not-allowed; margin-top: auto; transition: 0.3s; letter-spacing: 1px; text-transform: uppercase; }
        .btn-dl.ready { background: var(--accent); color: #000; cursor: pointer; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-dl.ready:hover { transform: translateY(-2px); }

        /* === PERFECT GLOW SYSTEM === */
        .custom-selected-pin { position: relative; }
        .custom-selected-pin .pin-img {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 25px; height: 41px; z-index: 10;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }
        .custom-selected-pin::after {
            content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 10px; height: 10px; background: #fff; border-radius: 50%;
            box-shadow: 0 0 10px var(--gold), 0 0 30px var(--accent);
            animation: pulseCore 2s infinite; z-index: 5; margin-top: 15px;
        }
        .custom-selected-pin::before {
            content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            animation: pulseWave 2s infinite ease-out; z-index: 1; margin-top: 15px;
        }

        .marker-cluster-selected {
            background-color: var(--accent) !important; color: #000 !important;
            box-shadow: 0 0 0 4px var(--gold), 0 0 40px var(--accent) !important;
            animation: pulseCluster 2s infinite;
        }
        .marker-cluster-selected div { background-color: var(--accent) !important; color: #000 !important; }

        @keyframes pulseCore { 0%, 100% { transform: translate(-50%,-50%) scale(1); opacity: 1; } 50% { transform: translate(-50%,-50%) scale(1.5); opacity: 0.8; } }
        @keyframes pulseWave { 0% { transform: translate(-50%,-50%) scale(0.2); opacity: 1; } 100% { transform: translate(-50%,-50%) scale(2.5); opacity: 0; } }
        @keyframes pulseCluster { 0% { box-shadow: 0 0 0 0px rgba(255,215,0, 0.8); } 70% { box-shadow: 0 0 0 20px rgba(255,215,0, 0); } 100% { box-shadow: 0 0 0 0px rgba(0,0,0,0); } }

        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: var(--accent-glow) !important; }
        .marker-cluster div { background-color: var(--accent) !important; color: #000 !important; font-weight: 800; border-radius: 50%; }

        /* DRAWER & TABLES */
        .drawer-overlay { position: absolute; top: var(--header-h); left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 150; display: none; backdrop-filter: blur(4px); cursor: pointer; }
        .drawer-overlay.active { display: block; }
        .drawer { position: absolute; top: var(--header-h); right: 0; bottom: 0; width: 600px; background: var(--bg-card); border-left: var(--border); z-index: 200; transform: translateX(100%); transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; box-shadow: var(--shadow); }
        .drawer.open { transform: translateX(0); }
        .doc-nav { display: flex; background: var(--bg-panel); border-bottom: var(--border); padding: 0 20px; gap: 10px; }
        .doc-tab { flex: 1; text-align: center; padding: 20px 0; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; text-transform: uppercase; }
        .doc-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .doc-content { padding: 40px 40px; overflow-y: auto; flex: 1; }
        .doc-section { display: none; animation: fadeIn 0.4s; }
        .doc-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .doc-h1 { font-size: 24px; font-weight: 900; margin-bottom: 10px; color: var(--text-main); }
        .doc-sub { font-size: 13px; color: var(--text-sub); margin-bottom: 30px; border-left: 3px solid var(--accent); padding-left: 12px; line-height: 1.6; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; border: var(--border); border-radius: 8px; overflow: hidden; }
        th { text-align: left; padding: 14px; background: rgba(125,125,125,0.04); color: var(--accent); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid rgba(125,125,125,0.1); }
        td { padding: 12px; border-bottom: 1px solid rgba(125,125,125,0.05); color: var(--text-main); font-size: 12px; line-height: 1.5; }
        .code-tag { font-family: 'JetBrains Mono'; color: var(--accent); background: rgba(125,125,125,0.1); padding: 3px 6px; border-radius: 4px; font-size: 11px; }
        .cite-block { background: rgba(125,125,125,0.03); border: var(--border); border-left: 4px solid var(--gold); padding: 20px; font-family: 'Georgia', serif; font-style: italic; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; border-radius: 0 10px 10px 0; font-size: 13px; }
    </style>
</head>
<body>

    <header>
        <div class="brand" onclick="location.reload()">
            <div class="logo">NCEI <span>GO</span></div>
            <div class="slogan">NCEI å³åˆ»å‡ºå‘ Â· Official Climate Archive</div>
        </div>
        <div class="theme-center-btn" onclick="toggleTheme()" id="theme-btn" title="Light/Dark Mode">â˜€ï¸</div>
        <div class="menu-bar">
            <button class="nav-btn active" onclick="closeDrawer()"><span class="nav-main-text">åœ°ç†æ§åˆ¶å°</span><span class="nav-sub-text">Console</span></button>
            <button class="nav-btn" onclick="toggleDrawer('doc', this)"><span class="nav-main-text">å˜é‡è¯´æ˜</span><span class="nav-sub-text">Variables</span></button>
            <button class="nav-btn" onclick="toggleDrawer('cite', this)"><span class="nav-main-text">å¼•ç”¨æ–¹å¼</span><span class="nav-sub-text">Citation</span></button>
            <button class="nav-btn" onclick="toggleDrawer('about', this)"><span class="nav-main-text">å…³äºæœ¬ç«™</span><span class="nav-sub-text">About</span></button>
        </div>
    </header>

    <div class="layout">
        <div class="map-box">
            <div class="db-status">
                <div class="db-indicator"><span id="label-daily">...</span><div class="dot" id="dot-daily"></div></div>
                <div class="db-indicator"><span id="label-hourly">...</span><div class="dot" id="dot-hourly"></div></div>
                <input type="file" id="file-input" hidden accept=".txt,.csv" onchange="handleFile(this)">
            </div>
            <div id="map"></div>
            <div class="drawer-overlay" onclick="closeDrawer()"></div>
        </div>

        <aside class="ctrl-box">
            <div class="ctrl-content">
                <div>
                    <div class="section-h">
                        <div><span class="h-cn">1. ç«™ç‚¹é€‰æ‹©</span><span class="h-en">Selection</span></div>
                        <div class="batch-switch">
                            <label class="switch-label" for="multi-check">æ‰¹é‡å¤šé€‰ <span style="font-size:9px; opacity:0.6; margin-left:2px;">(Shift+æ¡†é€‰)</span></label>
                            <label class="switch"><input type="checkbox" id="multi-check" class="switch-input"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="search-wrap">
                        <input type="text" id="search" placeholder="è¾“å…¥ ID æˆ–åŸå¸‚å (å¦‚ Beijing)..." oninput="handleSearch(this.value)">
                        <div class="search-res" id="results"></div>
                    </div>
                    <div class="status-card" id="status-card" style="margin-top:15px;">
                        <div class="st-title" id="sel-status" style="font-size:11px; color:var(--text-sub); font-weight:700; text-transform:uppercase; margin-bottom:4px;">æœªé€‰æ‹©ç«™ç‚¹</div>
                        <div class="st-val" id="st-name">ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹</div>
                        <div class="st-code" id="st-id">æ”¯æŒ Shift+æ¡†é€‰åŒºåŸŸ</div>
                    </div>
                    <div class="sel-list" id="sel-list"></div>
                </div>

                <div>
                    <div class="section-h"><div><span class="h-cn">2. æ•°æ®ç±»å‹</span><span class="h-en">Dataset</span></div></div>
                    <div class="mode-grid">
                        <div class="mode-btn" onclick="setMode('hourly')" id="m-hourly"><span class="mb-en">Hourly</span><span class="mb-cn">GHCNh</span></div>
                        <div class="mode-btn active" onclick="setMode('daily')" id="m-daily"><span class="mb-en">Daily</span><span class="mb-cn">GHCNd</span></div>
                        <div class="mode-btn" onclick="setMode('monthly')" id="m-monthly"><span class="mb-en">Monthly</span><span class="mb-cn">GSOM</span></div>
                        <div class="mode-btn" onclick="setMode('yearly')" id="m-yearly"><span class="mb-en">Yearly</span><span class="mb-cn">GSOY</span></div>
                    </div>
                </div>

                <div>
                    <div class="section-h"><div><span class="h-cn">3. æ—¶é—´èŒƒå›´</span><span class="h-en">Temporal</span></div></div>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="start-date" value="2023-01-01">
                        <input type="date" id="end-date" value="2023-01-31">
                    </div>
                </div>

                <div style="margin-top:auto;">
                    <div style="font-size:10px; color:var(--text-sub); text-align:center; margin-bottom:8px;">ğŸ”— é“¾æ¥ç›´æ¥è¯·æ±‚ NOAA NCEI å®˜æ–¹ API (Auto-Merge)</div>
                    <button class="btn-dl" id="dl-btn" onclick="download()">ä¸‹è½½æ•°æ® (CSV)</button>
                </div>
            </div>
        </aside>
    </div>

    <div class="drawer" id="doc-drawer">
        <div class="doc-nav">
            <div class="doc-tab active" id="tab-hourly" onclick="showDocSection('doc-hourly', this)">Hourly</div>
            <div class="doc-tab" id="tab-daily" onclick="showDocSection('doc-daily', this)">Daily</div>
            <div class="doc-tab" id="tab-monthly" onclick="showDocSection('doc-monthly', this)">Monthly/Yearly</div>
        </div>
        <div class="doc-content">
            <div id="doc-hourly" class="doc-section active">
                <div class="doc-h1">GHCN-Hourly (GHCNh)</div>
                <div class="doc-sub">Global Historical Climatology Network - Hourly. <br>API Dataset: <code>global-hourly</code>.</div>
                <h4 style="color:var(--text-main); margin-bottom:5px; font-size:14px;">æ ¸å¿ƒå˜é‡ (Variables)</h4>
                <table>
                    <tr><th>ä»£ç </th><th>è¯´æ˜</th><th>è§£æç¤ºä¾‹</th></tr>
                    <tr><td class="code-tag">TMP</td><td>æ°”æ¸© (Temperature)</td><td>+0250,1 (25.0Â°C)</td></tr>
                    <tr><td class="code-tag">DEW</td><td>éœ²ç‚¹æ¸©åº¦ (Dew Point)</td><td>+0100,1 (10.0Â°C)</td></tr>
                    <tr><td class="code-tag">WND</td><td>é£å†µ (Wind)</td><td>320,1,N,0050,1</td></tr>
                    <tr><td class="code-tag">SLP</td><td>æµ·å¹³é¢æ°”å‹ (Sea Level Pressure)</td><td>10132,1 (1013.2hPa)</td></tr>
                    <tr><td class="code-tag">VIS</td><td>èƒ½è§åº¦ (Visibility)</td><td>008000,1 (8000m)</td></tr>
                    <tr><td class="code-tag">AA1</td><td>é™æ°´ (Precipitation)</td><td>01,0050 (1h/5.0mm)</td></tr>
                    <tr><td class="code-tag">GA1</td><td>äº‘å±‚è¦†ç›– (Sky Cover)</td><td>08,1,+00600 (8åˆ†, 600m)</td></tr>
                </table>
                <p style="font-size:12px; color:var(--text-sub); margin-top:10px;">*æ³¨ï¼šHourly æ•°æ®ä¸ºå®šé•¿å­—ç¬¦ä¸²æ ¼å¼ï¼Œéœ€æ ¹æ®æ‰‹å†Œè§£æé€—å·åˆ†éš”çš„å­—æ®µã€‚</p>
            </div>

            <div id="doc-daily" class="doc-section">
                <div class="doc-h1">GHCN-Daily (GHCNd)</div>
                <div class="doc-sub">GHCN Daily Summaries.<br>API Dataset: <code>daily-summaries</code>. å•ä½ï¼šå…¬åˆ¶ (Metric)ã€‚</div>
                <table>
                    <tr><th>ä»£ç </th><th>å®Œæ•´åç§°</th><th>å•ä½</th></tr>
                    <tr><td class="code-tag">TMAX</td><td>æ—¥æœ€é«˜æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">TMIN</td><td>æ—¥æœ€ä½æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">PRCP</td><td>æ—¥é™æ°´é‡</td><td>mm</td></tr>
                    <tr><td class="code-tag">SNOW</td><td>é™é›ªé‡</td><td>mm</td></tr>
                    <tr><td class="code-tag">SNWD</td><td>ç§¯é›ªæ·±åº¦</td><td>mm</td></tr>
                    <tr><td class="code-tag">AWND</td><td>å¹³å‡é£é€Ÿ</td><td>m/s</td></tr>
                    <tr><td class="code-tag">WDF2</td><td>2åˆ†é’Ÿæœ€å¿«é£å‘</td><td>deg</td></tr>
                    <tr><td class="code-tag">TOBS</td><td>è§‚æµ‹æ—¶æ°”æ¸©</td><td>Â°C</td></tr>
                    <tr><td class="code-tag">EVAP</td><td>è’¸å‘é‡</td><td>mm</td></tr>
                </table>
            </div>

            <div id="doc-monthly" class="doc-section">
                <div class="doc-h1">GSOM / GSOY</div>
                <div class="doc-sub">Global Summary of Month / Year.</div>
                <table>
                    <tr><th>ä»£ç </th><th>å«ä¹‰</th></tr>
                    <tr><td class="code-tag">EMXP</td><td>æ—¶æ®µå†…æç«¯æœ€å¤§å•æ—¥é™æ°´</td></tr>
                    <tr><td class="code-tag">HTDD</td><td>é‡‡æš–åº¦æ—¥æ•° (Heating Degree Days)</td></tr>
                    <tr><td class="code-tag">CLDD</td><td>åˆ¶å†·åº¦æ—¥æ•° (Cooling Degree Days)</td></tr>
                    <tr><td class="code-tag">DT90</td><td>æ°”æ¸©â‰¥90Â°F (32.2Â°C) å¤©æ•°</td></tr>
                    <tr><td class="code-tag">DX32</td><td>æ°”æ¸©â‰¤32Â°F (0Â°C) å¤©æ•°</td></tr>
                </table>
            </div>

            <div id="view-cite" class="doc-section">
                <div class="doc-h1">å¼•ç”¨æ–¹å¼ (Citation)</div>
                <div class="doc-sub">ä½¿ç”¨æ•°æ®è¯·éµå¾ª NOAA NCEI å®˜æ–¹å¼•ç”¨è§„èŒƒã€‚</div>
                <h4 style="color:var(--text-main); margin-bottom:8px; font-size:14px;">GHCN-Daily</h4>
                <div class="cite-block">
                    Menne, M.J., I. Durre, R.S. Vose, B.E. Gleason, and T.G. Houston, 2012: An overview of the Global Historical Climatology Network-Daily Database. Journal of Atmospheric and Oceanic Technology, 29, 897-910, doi:10.1175/JTECH-D-11-00103.1.
                </div>
                <h4 style="color:var(--text-main); margin-bottom:8px; font-size:14px;">GHCN-Hourly</h4>
                <div class="cite-block">
                    Menne, Matthew J., et al. 2023. Global Historical Climatology Network-Hourly (GHCNh). NOAA National Centers for Environmental Information.
                </div>
            </div>

            <div id="view-about" class="doc-section">
                <div class="doc-h1">å…³äºæœ¬ç«™ (About)</div>
                <div style="padding:40px; background:rgba(125,125,125,0.03); border-radius:24px; border:var(--border);">
                    <div style="font-family:'Orbitron'; font-size:32px; font-weight:900;">NCEI <span>GO</span></div>
                    <div style="font-size:13px; color:var(--text-main); margin-top:25px; line-height:1.8;">
                        <p><strong>Global Historical Climatology Network (GHCN):</strong><br>æœ¬ç«™ç›´è¿ NOAA å®˜æ–¹ GHCN æ•°æ®åº“ï¼Œæ”¯æŒä»¥ä¸‹å…¨å°ºåº¦æ°”è±¡æ•°æ®å½’æ¡£çš„ä¸€é”®ä¸‹è½½ï¼š</p>
                        <ul style="margin:10px 0 20px 0; padding-left:20px; color:var(--text-sub);">
                            <li><strong>Hourly:</strong> GHCNh (åŒ…å« Synoptic/Airways æ•°æ®)</li>
                            <li><strong>Daily:</strong> GHCNd (æ—¥åº¦æ‘˜è¦)</li>
                            <li><strong>Monthly:</strong> GHCNm (GSOM æœˆåº¦æ‘˜è¦)</li>
                            <li><strong>Yearly:</strong> GHCNy (GSOY å¹´åº¦æ‘˜è¦)</li>
                        </ul>

                        <p><strong>åŒæ ¸ç´¢å¼•å¼•æ“ (Dual-Core Indexing):</strong><br>
                        é‰´äº GHCN-Hourly ä½¿ç”¨ç‹¬ç«‹äºå…¶ä»–å°ºåº¦çš„ç«™ç‚¹ç´¢å¼•ä½“ç³» (USAF ID)ï¼Œæœ¬ç³»ç»Ÿé‡‡ç”¨åŒæ ¸æ¶æ„è‡ªåŠ¨åˆ‡æ¢åº•å±‚ç´¢å¼•æ–‡ä»¶ (<code>isd-history</code> vs <code>ghcnd-stations</code>)ï¼Œå½»åº•è§£å†³äº†ä¸åŒæ—¶é—´å°ºåº¦ä¸‹å›  ID ä¸åŒ¹é…å¯¼è‡´çš„æ•°æ®è¯·æ±‚å¤±è´¥é—®é¢˜ã€‚</p>
                        
                        <p style="margin-top:20px; color:var(--gold);"><strong>æ•°æ®è¦†ç›–å±€é™æ€§ (Limitations):</strong><br>
                        æœ¬ç«™æ•°æ®æºäº NOAA NCEI çš„å…¬å¼€å­˜æ¡£ï¼Œå—ä¸–ç•Œæ°”è±¡ç»„ç»‡ (WMO) ç¬¬ 40 å·å†³è®®åŠå„å›½æ•°æ®å…±äº«æ”¿ç­–çº¦æŸã€‚ä»…åŒ…å«å‚ä¸å›½é™…äº¤æ¢çš„ç«™ç‚¹æ•°æ®ï¼Œå¹¶éåŒ…å«å…¨çƒæ‰€æœ‰æ°”è±¡ç«™ï¼ˆä¾‹å¦‚éƒ¨åˆ†å†›ç”¨ã€ç§æœ‰æˆ–éå›½é™…äº¤æ¢ç«™ç‚¹æ— æ³•è·å–ï¼‰ã€‚</p>

                        <div style="margin-top:30px; border-top:1px solid rgba(125,125,125,0.1); padding-top:20px; color:var(--text-sub);">
                            <p style="margin-bottom:15px;"><strong>å…è´£å£°æ˜ï¼š</strong><br>
                            1. æœ¬é¡¹ç›®ä»…ä¾›å­¦æœ¯ç ”ç©¶ä¸æ•™è‚²ä½¿ç”¨ (Educational Purpose Only)ã€‚<br>
                            2. æ‰€æœ‰æ•°æ®é“¾æ¥ç›´è¿ NOAA å®˜æ–¹æœåŠ¡å™¨ï¼Œæœ¬ç«™ä¸å­˜å‚¨ä»»ä½•æ°”è±¡æ•°æ®ã€‚<br>
                            3. å¼€å‘è€…ä¸å¯¹ NOAA æ•°æ®çš„å‡†ç¡®æ€§åŠæœåŠ¡çš„å¯ç”¨æ€§æ‰¿æ‹…è´£ä»»ã€‚</p>

                            <div>Developer: <strong>Liang Ren</strong></div>
                            <div style="font-family:'JetBrains Mono'; font-size:12px; margin-top:5px;">rl23@mails.tsinghua.edu.cn</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const CORE_CITIES_DAILY = [{id:"CHM00054511",name:"BEIJING",lat:39.933,lon:116.283},{id:"CHM00058362",name:"SHANGHAI",lat:31.400,lon:121.467},{id:"JA000047662",name:"TOKYO",lat:35.683,lon:139.767},{id:"USW00094728",name:"NEW YORK CNTRL PK",lat:40.779,lon:-73.969},{id:"UK000056225",name:"OXFORD",lat:51.767,lon:-1.267},{id:"FR000007150",name:"PARIS/LE BOURGET",lat:48.967,lon:2.433},{id:"GM000003380",name:"BERLIN-DAHLEM",lat:52.450,lon:13.300},{id:"ASN00066062",name:"SYDNEY OBS HILL",lat:-33.861,lon:151.210},{id:"IN000042182",name:"NEW DELHI/SAFDARJUN",lat:28.583,lon:77.200},{id:"SF000068263",name:"PRETORIA",lat:-25.733,lon:28.183},{id:"BR002660040",name:"BRASILIA",lat:-15.783,lon:-47.933}];
        const CORE_CITIES_HOURLY = [{id:"54511099999",name:"BEIJING - CAPITAL",lat:40.08,lon:116.58},{id:"47662099999",name:"TOKYO INTL",lat:35.55,lon:139.78},{id:"72503014732",name:"NEW YORK LA GUARDIA",lat:40.77,lon:-73.87},{id:"03772099999",name:"HEATHROW",lat:51.48,lon:-0.45},{id:"07150099999",name:"PARIS - LE BOURGET",lat:48.97,lon:2.42},{id:"94767099999",name:"SYDNEY ARPT",lat:-33.95,lon:151.18},{id:"42181099999",name:"NEW DELHI PALAM",lat:28.57,lon:77.12},{id:"48698099999",name:"SINGAPORE CHANGI",lat:1.35,lon:103.98}];

        let db = { daily: [], hourly: [] };
        let map, clusterLayer;
        let markerMap = new Map();
        let selectedStations = new Set();
        let currentMode = 'daily';

        const defaultIcon = new L.Icon.Default();
        const selectedIcon = L.divIcon({
            className: 'custom-selected-pin',
            html: '<img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="pin-img">',
            iconSize: [25, 41], iconAnchor: [12, 41]
        });

        function init() {
            map = L.map('map', { zoomControl: false, boxZoom: true }).setView([30, 0], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            updateTiles();

            clusterLayer = L.markerClusterGroup({ 
                chunkedLoading: true, 
                showCoverageOnHover: false, 
                maxClusterRadius: 45,
                spiderfyOnMaxZoom: true,
                iconCreateFunction: function (cluster) {
                    const children = cluster.getAllChildMarkers();
                    let hasSelected = false;
                    for(let i=0; i<children.length; i++) {
                        if(selectedStations.has(children[i].stationData)) { hasSelected = true; break; }
                    }
                    const icon = L.MarkerClusterGroup.prototype._defaultIconCreateFunction(cluster);
                    if(hasSelected) icon.options.className += ' marker-cluster-selected';
                    return icon;
                }
            });
            map.addLayer(clusterLayer);

            map.on('click', (e) => {
                if(e.originalEvent.target.classList.contains('leaflet-container')) {
                    selectedStations.clear(); refreshMapState();
                    if(document.querySelector('.drawer').classList.contains('open')) closeDrawer();
                }
            });

            map.boxZoom.addHooks();
            map.on('boxzoomend', (e) => handleBoxSelect(e.boxZoomBounds));

            loadDualCores();
        }

        async function loadDualCores() {
            try {
                const res = await fetch('ghcnd-stations.txt'); if(!res.ok) throw 0;
                parseData(await res.text(), 'daily');
            } catch(e) { db.daily = CORE_CITIES_DAILY; }
            try {
                const res = await fetch('isd-history.csv'); if(!res.ok) throw 0;
                parseData(await res.text(), 'hourly');
            } catch(e) { db.hourly = CORE_CITIES_HOURLY; }
            renderMap();
        }

        function parseData(text, type) {
            const lines = text.split('\n');
            const arr = [];
            if(type === 'daily') {
                for(let line of lines) {
                    if(line.length > 20) {
                        const latStr = line.substring(12,20).trim();
                        const lonStr = line.substring(21,30).trim();
                        if(latStr && lonStr) {
                            const lat = parseFloat(latStr), lon = parseFloat(lonStr);
                            if(!isNaN(lat) && !isNaN(lon)) arr.push({ id: line.substring(0,11).trim(), lat: lat, lon: lon, name: line.substring(41,71).trim() });
                        }
                    }
                }
                db.daily = arr;
            } else {
                for(let i=1; i<lines.length; i++) {
                    const p = lines[i].split(',');
                    if(p.length > 7) {
                        const lat = parseFloat(p[6].replace(/"/g,'')), lon = parseFloat(p[7].replace(/"/g,''));
                        if(!isNaN(lat) && !isNaN(lon)) arr.push({ id: p[0].replace(/"/g,'')+p[1].replace(/"/g,''), name: p[2].replace(/"/g,''), lat:lat, lon:lon });
                    }
                }
                db.hourly = arr;
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('m-'+mode).classList.add('active');
            
            const root = document.documentElement;
            if(mode === 'hourly') { root.style.setProperty('--accent', 'var(--purple)'); root.style.setProperty('--accent-glow', 'var(--purple-glow)'); }
            else { root.style.setProperty('--accent', 'var(--cyan)'); root.style.setProperty('--accent-glow', 'var(--cyan-glow)'); }
            
            selectedStations.clear();
            refreshMapState();
            renderMap();
        }

        function renderMap() {
            clusterLayer.clearLayers();
            markerMap.clear();
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            const markers = [];
            
            for(let i=0; i<stations.length; i++) {
                const s = stations[i];
                const m = L.marker([s.lat, s.lon]);
                m.stationData = s; 
                m.on('click', (e) => { L.DomEvent.stopPropagation(e); handlePointClick(s); });
                markers.push(m);
                markerMap.set(s.id, m);
            }
            clusterLayer.addLayers(markers);
        }

        function handlePointClick(s) {
            const isMulti = document.getElementById('multi-check').checked;
            if(isMulti) {
                if(selectedStations.has(s)) selectedStations.delete(s);
                else selectedStations.add(s);
            } else {
                selectedStations.clear(); selectedStations.add(s);
            }
            refreshMapState();
        }

        function handleBoxSelect(bounds) {
            document.getElementById('multi-check').checked = true;
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            let count = 0;
            for(let s of stations) {
                if(bounds.contains([s.lat, s.lon])) { selectedStations.add(s); count++; }
                if(count > 500) break;
            }
            refreshMapState();
        }

        function refreshMapState() {
            markerMap.forEach((marker) => {
                const isSelected = selectedStations.has(marker.stationData);
                if(isSelected) {
                    if(marker.getIcon() !== selectedIcon) { marker.setIcon(selectedIcon); marker.setZIndexOffset(1000); }
                } else {
                    if(marker.getIcon() !== defaultIcon) { marker.setIcon(defaultIcon); marker.setZIndexOffset(0); }
                }
            });
            clusterLayer.refreshClusters();
            updateSidebar();
        }

        function updateSidebar() {
            const card = document.getElementById('status-card');
            const btn = document.getElementById('dl-btn');
            const list = document.getElementById('sel-list');
            const arr = Array.from(selectedStations);

            if(arr.length === 0) {
                card.classList.remove('active');
                document.getElementById('sel-status').textContent = "æœªé€‰æ‹©ç«™ç‚¹";
                document.getElementById('st-name').textContent = "ç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹";
                document.getElementById('st-id').textContent = "æ”¯æŒ Shift+æ¡†é€‰åŒºåŸŸ";
                btn.className = 'btn-dl'; btn.disabled = true;
                list.style.display = 'none';
            } else {
                card.classList.add('active');
                document.getElementById('sel-status').textContent = "å·²é€‰ä¸­";
                if(arr.length === 1) {
                    document.getElementById('st-name').textContent = arr[0].name;
                    document.getElementById('st-id').textContent = "ID: " + arr[0].id;
                    list.style.display = 'none';
                } else {
                    document.getElementById('st-name').textContent = `å·²é€‰ ${arr.length} ä¸ªç«™ç‚¹`;
                    document.getElementById('st-id').textContent = "ç«™ç‚¹åˆ—è¡¨å¦‚ä¸‹ â†“";
                    list.style.display = 'block';
                    list.innerHTML = arr.map(s => `
                        <div class="sel-item"><span>${s.name.substring(0,25)}</span><span class="sel-del" onclick="removeOne('${s.id}')">Ã—</span></div>
                    `).join('');
                }
                btn.className = 'btn-dl ready'; btn.innerText = `ä¸‹è½½æ•°æ® (CSV)`; btn.disabled = false;
            }
        }

        window.removeOne = function(id) {
            for(let s of selectedStations) { if(s.id === id) { selectedStations.delete(s); break; } }
            refreshMapState();
        }

        function handleSearch(val) {
            const res = document.getElementById('results');
            res.innerHTML = '';
            if(val.length < 2) { res.style.display = 'none'; return; }
            const stations = (currentMode === 'hourly') ? db.hourly : db.daily;
            const matches = stations.filter(s => s.name.toUpperCase().includes(val.toUpperCase()) || s.id.includes(val.toUpperCase())).slice(0, 15);
            matches.forEach(s => {
                const d = document.createElement('div'); d.className = 'search-item';
                d.innerHTML = `<b>${s.name}</b> <span>${s.id}</span>`;
                d.onclick = () => {
                    map.setView([s.lat, s.lon], 10);
                    selectedStations.clear(); selectedStations.add(s); refreshMapState();
                    res.style.display = 'none'; document.getElementById('search').value = s.name;
                };
                res.appendChild(d);
            });
            res.style.display = matches.length ? 'block' : 'none';
        }

        function download() {
            if(selectedStations.size === 0) return;
            const baseUrl = "https://www.ncei.noaa.gov/access/services/data/v1";
            let dataset = 'daily-summaries', dataTypes = '';
            if(currentMode === 'hourly') dataset = 'global-hourly';
            else if(currentMode === 'daily') { dataset = 'daily-summaries'; dataTypes = 'TMAX,TMIN,PRCP,TAVG,SNOW,SNWD,AWND'; }
            else if(currentMode === 'monthly') dataset = 'global-summary-of-the-month';
            else if(currentMode === 'yearly') dataset = 'global-summary-of-the-year';

            const ids = Array.from(selectedStations).map(s => s.id).join(',');
            const params = new URLSearchParams({ dataset: dataset, stations: ids, startDate: document.getElementById('start-date').value, endDate: document.getElementById('end-date').value, format: 'csv', units: 'metric', includeStationName: 'true' });
            if(dataTypes) params.append('dataTypes', dataTypes);
            window.open(`${baseUrl}?${params.toString()}`, '_blank');
        }

        function toggleDrawer(view, btn) {
            const d = document.getElementById('doc-drawer');
            const o = document.querySelector('.drawer-overlay');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) {
                if(d.classList.contains('open') && btn.classList.contains('last-clicked')) { closeDrawer(); return; }
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('last-clicked'));
                btn.classList.add('active'); btn.classList.add('last-clicked');
                d.classList.add('open'); o.classList.add('active');
                document.querySelectorAll('.doc-section').forEach(s => s.classList.remove('active'));
                document.querySelector('.doc-nav').style.display = (view==='doc') ? 'flex' : 'none';
                if(view === 'doc') showDocSection('doc-hourly', document.getElementById('tab-hourly'));
                else if(view === 'cite') document.getElementById('view-cite').classList.add('active');
                else if(view === 'about') document.getElementById('view-about').classList.add('active');
            }
        }

        function showDocSection(id, tab) {
            document.querySelectorAll('.doc-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        }

        function closeDrawer() {
            document.getElementById('doc-drawer').classList.remove('open');
            document.querySelector('.drawer-overlay').classList.remove('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
        }

        function toggleTheme() {
            const root = document.documentElement;
            const isDark = root.getAttribute('data-theme') === 'dark';
            root.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('theme-btn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            updateTiles();
        }

        function updateTiles() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.TileLayer) map.removeLayer(l); });
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const url = isDark 
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            L.tileLayer(url, { subdomains: 'abcd', maxZoom: 19, attribution: '&copy; CARTO' }).addTo(map);
        }

        function handleFile(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if(file.name.includes('csv')) { parseData(e.target.result,'hourly'); setMode('hourly'); }
                else { parseData(e.target.result,'daily'); setMode('daily'); }
                alert("Updated!");
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
